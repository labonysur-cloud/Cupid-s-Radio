<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cupid's Radio</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        :root {
            --bg: #fdfbf7;
            --red: #8B0000;
            --paper: #fffef8;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            font-family: 'Courier New', Courier, monospace;
            color: var(--red);
            height: 100vh; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Gingham Pattern */
        .bg-pattern {
            position: fixed; inset: 0; opacity: 0.08;
            background-image:
                linear-gradient(45deg, var(--red) 25%, transparent 25%, transparent 75%, var(--red) 75%, var(--red)),
                linear-gradient(45deg, var(--red) 25%, transparent 25%, transparent 75%, var(--red) 75%, var(--red));
            background-position: 0 0, 20px 20px;
            background-size: 40px 40px;
            pointer-events: none; z-index: -1;
        }

        .screen {
            height: 100%; display: flex; flex-direction: column;
            padding: 20px; box-sizing: border-box;
            max-width: 500px; margin: 0 auto;
        }

        .card {
            background: var(--paper);
            border: 1px solid rgba(139, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.05);
            border-radius: 20px; padding: 24px; margin-bottom: 20px;
            text-align: center;
        }

        /* Heart Play Button */
        .heart-play-container { display: flex; justify-content: center; margin: 15px 0; }
        
        .heart-btn {
            background: var(--red); color: white; width: 140px; padding: 12px 20px;
            border-radius: 50px; border: none; cursor: pointer;
            box-shadow: 0 6px 15px rgba(139,0,0,0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-family: inherit; font-weight: bold; font-size: 16px;
            transition: transform 0.2s;
        }
        .heart-btn:active { transform: scale(0.95); }
        .heart-btn.playing { background: #ff4d4d; animation: pulse-heart 1.5s infinite; }

        @keyframes pulse-heart {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
        }

        /* Record Button */
        .record-btn {
            background: white; border: 2px solid var(--red); color: var(--red);
            padding: 12px 24px; border-radius: 50px; font-weight: bold; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto;
            transition: all 0.2s;
        }
        .record-btn.recording { background: var(--red); color: white; animation: pulse-red 2s infinite; }
        
        /* Action Buttons */
        .btn-action {
            background: var(--red); color: white; border: none; padding: 16px;
            border-radius: 50px; font-size: 16px; font-weight: bold; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(139, 0, 0, 0.2); transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.97); }

        textarea {
            width: 100%; min-height: 150px; border: none;
            background: repeating-linear-gradient(transparent, transparent 31px, rgba(139,0,0,0.05) 31px, rgba(139,0,0,0.05) 32px);
            line-height: 32px; font-size: 18px; outline: none; resize: none;
            color: #333; font-family: 'Courier New', Courier, monospace;
        }

        .header-cute {
            font-size: 12px; font-weight: bold; color: #888; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 2px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 99; display: flex; justify-content: center; align-items: center; color: var(--red); font-weight: bold; }
        #error-log { display: none; position: fixed; top: 0; left: 0; width: 100%; background: black; color: #ff5555; padding: 20px; font-size: 12px; z-index: 9999; }
    </style>
</head>
<body>
    <div id="loader">LOADING...</div>
    <div id="error-log"></div>
    <div class="bg-pattern"></div>
    <div id="root"></div>

    <script type="text/babel">
        window.onerror = function(msg, url, line) {
            const el = document.getElementById('error-log');
            el.style.display = 'block';
            el.innerHTML += `<div>Error: ${msg} (Line ${line})</div>`;
            document.getElementById('loader').style.display = 'none';
        };

        const { useState, useRef, useEffect } = React;

        setTimeout(() => {
            const loader = document.getElementById('loader');
            if(loader) loader.style.display = 'none';
        }, 1000);

        // --- ICONS ---
        const Icon = ({ name, className, color }) => {
            const icons = {
                mic: <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z M19 10v2a7 7 0 0 1-14 0v-2 M12 19v4 M8 23h8" />,
                heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />,
                share: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13" />,
                lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />,
                play: <polygon points="5 3 19 12 5 21 5 3" />,
                stop: <rect x="6" y="6" width="12" height="12" rx="2" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />,
                music_cute: (
                    <g transform="translate(2, 2)">
                        <path d="M9 18V5l12-2v13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        <circle cx="6" cy="18" r="3.5" fill="currentColor" />
                        <circle cx="21" cy="16" r="3.5" fill="currentColor" />
                        <path d="M6 3 C6 1 8 1 9 2.5 C10 1 12 1 12 3 C12 5.5 9 7.5 9 7.5 C9 7.5 6 5.5 6 3 Z" fill="currentColor" transform="translate(-1, 0) rotate(-15)" />
                    </g>
                )
            };
            return <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{overflow:'visible'}}>{icons[name]}</svg>;
        };

        // --- RADIO PLAYER ---
        const RadioPlayer = ({ audioBlob }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const audioCtxRef = useRef(null);
            
            const play = async () => {
                if(isPlaying) {
                    if(audioCtxRef.current) audioCtxRef.current.close();
                    setIsPlaying(false);
                    return;
                }
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const ctx = new AudioContext();
                    audioCtxRef.current = ctx;

                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                    
                    const source = ctx.createBufferSource();
                    source.buffer = audioBuffer;

                    const highpass = ctx.createBiquadFilter(); highpass.type = "highpass"; highpass.frequency.value = 600;
                    const lowpass = ctx.createBiquadFilter(); lowpass.type = "lowpass"; lowpass.frequency.value = 3000;
                    const comp = ctx.createDynamicsCompressor(); comp.threshold.value = -20;
                    
                    source.connect(highpass); highpass.connect(lowpass); lowpass.connect(comp); comp.connect(ctx.destination);
                    source.start(0);
                    setIsPlaying(true);
                    source.onended = () => setIsPlaying(false);
                } catch(e) {
                    const audio = new Audio(URL.createObjectURL(audioBlob));
                    audio.play();
                    setIsPlaying(true);
                    audio.onended = () => setIsPlaying(false);
                }
            };
            return (
                <div className="heart-play-container">
                    <button className={`heart-btn ${isPlaying ? 'playing' : ''}`} onClick={play}>
                        <Icon name={isPlaying ? "stop" : "heart"} />
                        {isPlaying ? "STOP" : "PLAY ME"}
                    </button>
                </div>
            );
        };

        // --- CRYPTO HELPERS ---
        const encryptText = (text, pass) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const key = encoder.encode(pass);
            const encrypted = data.map((byte, i) => byte ^ key[i % key.length]);
            let binary = '';
            for (let i = 0; i < encrypted.length; i++) binary += String.fromCharCode(encrypted[i]);
            return btoa(binary);
        };

        const decryptText = (base64, pass) => {
            const binaryStr = atob(base64);
            const data = new Uint8Array(binaryStr.length);
            for(let i=0; i<binaryStr.length; i++) data[i] = binaryStr.charCodeAt(i);
            const encoder = new TextEncoder();
            const key = encoder.encode(pass);
            const decrypted = data.map((byte, i) => byte ^ key[i % key.length]);
            const decoder = new TextDecoder();
            return decoder.decode(decrypted);
        };

        // --- APP ---
        const App = () => {
            const [view, setView] = useState('home');
            const [isRecording, setIsRecording] = useState(false);
            const [audioBlob, setAudioBlob] = useState(null);
            const [letter, setLetter] = useState("");
            const [code, setCode] = useState("");
            const [shareFile, setShareFile] = useState(null);
            const [receivedData, setReceivedData] = useState(null);
            const [unlockCode, setUnlockCode] = useState("");
            const mediaRecorder = useRef(null);
            const chunks = useRef([]);

            // Universal Recording
            const toggleRecording = async () => {
                if(isRecording) {
                    if(mediaRecorder.current) mediaRecorder.current.stop();
                    setIsRecording(false);
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        let options = {};
                        if (MediaRecorder.isTypeSupported('audio/webm')) options = { mimeType: 'audio/webm' };
                        else if (MediaRecorder.isTypeSupported('audio/mp4')) options = { mimeType: 'audio/mp4' };
                        
                        mediaRecorder.current = new MediaRecorder(stream, options);
                        mediaRecorder.current.ondataavailable = e => { if(e.data.size > 0) chunks.current.push(e.data); };
                        mediaRecorder.current.onstop = () => {
                            const blob = new Blob(chunks.current, { type: chunks.current[0].type });
                            setAudioBlob(blob);
                            stream.getTracks().forEach(t => t.stop());
                        };
                        chunks.current = [];
                        mediaRecorder.current.start();
                        setIsRecording(true);
                    } catch(e) { alert("Microphone access needed!"); }
                }
            };

            const seal = () => {
                if(!code || (!audioBlob && !letter)) return alert("Missing content or code!");
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob || new Blob([]));
                reader.onloadend = () => {
                    const payload = JSON.stringify({ t: letter, a: reader.result });
                    const enc = encryptText(payload, code.toUpperCase());
                    const file = new File([JSON.stringify({ app:"cupid", d: enc })], "Cupid_Signal.json", { type: "application/json" });
                    setShareFile(file);
                };
            };

            // Android-Proof Download Function
            const triggerDownload = () => {
                const url = URL.createObjectURL(shareFile);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Valentine_${code}.json`;
                document.body.appendChild(a); // CRITICAL: Append to body for Android support
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            };

            const share = async () => {
                // Detect HTTPS context
                const isHTTPS = window.location.protocol === 'https:';
                
                // Safe feature detection for Web Share API
                const hasNavigatorShare = typeof navigator !== 'undefined' && 'share' in navigator;
                const hasCanShare = hasNavigatorShare && typeof navigator.canShare === 'function';
                
                let canShareFiles = false;
                
                // Try to check if we can share files (with error handling for browsers that don't support canShare)
                if (hasCanShare) {
                    try {
                        canShareFiles = navigator.canShare({ files: [shareFile] });
                    } catch (e) {
                        // Some browsers throw errors when checking canShare
                        // Fall back to checking if share exists (we'll try sharing and handle errors)
                        canShareFiles = false;
                    }
                }
                
                // Attempt native share if conditions are met
                if (hasNavigatorShare && (canShareFiles || !hasCanShare)) {
                    try {
                        // Try to share with all data
                        await navigator.share({ 
                            files: [shareFile], 
                            title: 'Valentine Message', 
                            text: `Unlock with code: ${code}` 
                        });
                        // Success - share was completed (or could have been cancelled by user choosing "cancel")
                        return;
                    } catch (e) {
                        // Handle different error types
                        if (e.name === 'AbortError') {
                            // User cancelled the share dialog - this is normal, do nothing
                            return;
                        } else if (e.name === 'NotAllowedError') {
                            // Permission denied or HTTPS required
                            if (!isHTTPS) {
                                alert('File sharing requires HTTPS. Downloading file instead.');
                            }
                            // Fall through to download
                        } else if (e.name === 'TypeError' || e.name === 'NotSupportedError') {
                            // Browser doesn't support file sharing or the file type
                            // Fall through to download silently
                        } else {
                            // Other errors - log for debugging in development
                            console.warn('Share failed:', e.name, e.message);
                            // Fall through to download
                        }
                    }
                }
                
                // Fallback to download for all cases where share isn't available or failed
                triggerDownload();
            };

            const upload = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = ev => { try { const j = JSON.parse(ev.target.result); if(j.app==="cupid") setReceivedData(j.d); } catch(e) {} };
                r.readAsText(f);
            };

            const unlock = () => {
                try {
                    const dec = decryptText(receivedData, unlockCode.toUpperCase());
                    const data = JSON.parse(dec);
                    fetch(data.a).then(r=>r.blob()).then(b=>{ setAudioBlob(b); setLetter(data.t); setView('read'); });
                } catch(e) { alert("Wrong Code"); }
            };

            if(view === 'home') return (
                <div className="screen" style={{justifyContent:'center'}}>
                    <div className="card">
                        <div style={{color:'var(--red)', marginBottom:10}}><Icon name="heart"/></div>
                        <h1 style={{margin:0, fontSize:24}}>Cupid's Radio</h1>
                        <p style={{fontSize:12, opacity:0.6}}>SECURE FREQUENCY</p>
                    </div>
                    <button className="btn-action" onClick={() => setView('create')}> <Icon name="mic"/> Record Signal </button>
                    <div style={{height:15}}></div>
                    <button className="btn-action" style={{background:'white', color:'var(--red)', border:'2px solid var(--red)'}} onClick={() => setView('receive')}> <Icon name="lock"/> Open Signal </button>
                </div>
            );

            if(view === 'create') return (
                <div className="screen">
                    <div style={{display:'flex', marginBottom:20}}>
                        <button onClick={() => setView('home')} style={{background:'none', border:'none', color:'var(--red)'}}>BACK</button>
                        <span style={{flex:1, textAlign:'center', fontWeight:'bold', color:'var(--red)'}}>COMPOSE</span>
                        <div style={{width:40}}></div>
                    </div>
                    <div className="card">
                        <div className="header-cute"> Voice Note <Icon name="music_cute" color="#8B0000" /> </div>
                        {!audioBlob ? (
                            <button className={`record-btn ${isRecording ? 'recording' : ''}`} onClick={toggleRecording}>
                                <Icon name={isRecording ? "stop" : "mic"} />
                                {isRecording ? "STOP RECORDING" : "START RECORDING"}
                            </button>
                        ) : (
                            <div>
                                <RadioPlayer audioBlob={audioBlob} />
                                <button style={{background:'none', border:'none', textDecoration:'underline', color:'#888', fontSize:12, marginTop:10}} onClick={() => setAudioBlob(null)}>Record Again</button>
                            </div>
                        )}
                    </div>
                    <div className="card" style={{padding:15}}>
                        <textarea placeholder="Write your letter here..." value={letter} onChange={e => setLetter(e.target.value)} />
                    </div>
                    <div className="card" style={{background:'var(--red)', color:'white'}}>
                        {!shareFile ? (
                            <>
                                <label style={{fontSize:10, fontWeight:'bold', display:'block', marginBottom:5}}>SET SECRET CODE</label>
                                <input value={code} onChange={e => setCode(e.target.value)} style={{width:'80%', padding:10, borderRadius:8, border:'none', textAlign:'center', fontSize:18, marginBottom:10, textTransform:'uppercase', color:'black'}} placeholder="LOVE" />
                                <button className="btn-action" style={{background:'white', color:'var(--red)'}} onClick={seal}>SEAL CAPSULE</button>
                            </>
                        ) : (
                            <>
                                <h3 style={{margin:0}}>Ready!</h3>
                                <p style={{fontSize:12, opacity:0.8, marginBottom:10}}>Code: {code}</p>
                                <button className="btn-action" style={{background:'white', color:'var(--red)'}} onClick={share}> <Icon name="share"/> SHARE FILE </button>
                                {/* Added Safety Net Link for Android */}
                                <button style={{background:'none', border:'none', textDecoration:'underline', color:'white', fontSize:12, marginTop:10, opacity:0.8}} onClick={triggerDownload}>
                                    (Or click here to download file)
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );

            if(view === 'receive') return (
                <div className="screen" style={{justifyContent:'center'}}>
                    <button onClick={() => setView('home')} style={{position:'absolute', top:20, left:20, background:'none', border:'none', color:'var(--red)'}}>BACK</button>
                    <div className="card">
                        <h2>Receive</h2>
                        <input type="file" accept=".json" onChange={upload} style={{marginBottom:20}} />
                        {receivedData && (
                            <>
                                <input value={unlockCode} onChange={e => setUnlockCode(e.target.value)} style={{width:'80%', padding:10, borderRadius:8, border:'1px solid #ccc', textAlign:'center', fontSize:18, marginBottom:10, textTransform:'uppercase'}} placeholder="ENTER CODE" />
                                <button className="btn-action" onClick={unlock}>UNLOCK</button>
                            </>
                        )}
                    </div>
                </div>
            );

            if(view === 'read') return (
                <div className="screen">
                    <button onClick={() => setView('home')} style={{marginBottom:20, background:'none', border:'none', color:'var(--red)'}}>CLOSE</button>
                    {audioBlob && (
                        <div className="card">
                            <div className="header-cute"> Incoming Voice <Icon name="music_cute" color="#8B0000" /> </div>
                            <RadioPlayer audioBlob={audioBlob} />
                        </div>
                    )}
                    <div className="card" style={{textAlign:'left', whiteSpace:'pre-wrap'}}>
                        {letter}
                        <div style={{textAlign:'center', marginTop:30, color:'var(--red)'}}><Icon name="heart"/></div>
                    </div>
                </div>
            );
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


